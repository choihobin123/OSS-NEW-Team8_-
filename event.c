#define _CRT_SECURE_NO_WARNINGS
#include "gamefunc.h"
#include <stdio.h>
#include <string.h>
#include <stdlib.h>

void printStatus(const State* st) {
    printf("\n[í˜„ì¬ ìƒíƒœ]\n");
    printf("ìŠ¤íŠ¸ë ˆìŠ¤ : %d\n", st->stress);
    printf("ì‹¤ë ¥     : %d\n", st->skill);
    printf("ì—¬ì¹œ     : %s\n\n", st->gf ? "ìˆìŒ" : "ì—†ìŒ");
}

int printOpeningMenu() {
    char buf[128];
    long val;
    char* endptr;

    while (1) { // ìœ íš¨í•œ ì…ë ¥ì´ ë‚˜ì˜¬ ë•Œê¹Œì§€ ë°˜ë³µ
		system("cls");
        printf("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n");
        printf("â”‚      ì¸ìƒ.exe - ìˆ˜ëŠ¥ ì´í›„                â”‚\n");
        printf("â”‚  ë‹¹ì‹ ì˜ ì„ íƒì´ í•œ í˜ì´ì§€ì”© ê¸°ë¡ë˜ëŠ” ê²Œì„ â”‚\n");
        printf("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\n");

        printf("  1. ìƒˆ ê²Œì„ ì‹œì‘\n");
        printf("  2. ê²Œì„ ì„¤ëª…\n");
        printf("  3. ì¢…ë£Œ\n\n");
        printf("ì›í•˜ëŠ” í•­ëª©ì„ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš” (1~3): ");

        if (!fgets(buf, sizeof(buf), stdin)) {
            // ì…ë ¥ ì‹¤íŒ¨ ì²˜ë¦¬
            clearerr(stdin);
            printf("\nì…ë ¥ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì¢…ë£Œ ì²˜ë¦¬í•©ë‹ˆë‹¤.\n");
            return 3;
        }

        // ì…ë ¥ ë¬¸ìì—´ì—ì„œ ê°œí–‰ ë¬¸ì ì œê±°
        size_t len = strlen(buf);
        if (len > 0 && buf[len - 1] == '\n') {
            buf[len - 1] = '\0';
            len--;
        }

        // ì…ë ¥ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
        if (len == 0) {
            continue;
        }

        // ìˆ«ì ë³€í™˜ ë° ê²€ì¦
        val = strtol(buf, &endptr, 10);

        // ìˆ«ìê°€ ì•„ë‹ˆê±°ë‚˜, ìˆ«ì ì™¸ ë‹¤ë¥¸ ë¬¸ìê°€ ì„ì—¬ìˆë‹¤ë©´
        if (endptr == buf || *endptr != '\0') {
            printf("ì˜ëª»ëœ ì…ë ¥ì…ë‹ˆë‹¤. ìˆ«ì(1~3)ë§Œ ì…ë ¥í•˜ì„¸ìš”.\n\n");
            continue;
        }

        // ìœ íš¨í•œ ì…ë ¥ ëŒ€ì‘
        if (val == 1) {
            return 1; // ìƒˆ ê²Œì„ ì‹œì‘
        }
        else if (val == 2) {
            system("cls");
            // ê²Œì„ ì„¤ëª… ì¶œë ¥
            printf("\n=== ê²Œì„ ì„¤ëª… ===\n");
            printf("ì´ ê²Œì„ì€ ìˆ˜ëŠ¥ ì´í›„ì˜ ê³µëŒ€ìƒ ì‚¶ì„ ë”°ë¼ê°€ëŠ” í…ìŠ¤íŠ¸ ê¸°ë°˜ ì¸í„°ë™í‹°ë¸Œ í”½ì…˜ì…ë‹ˆë‹¤.\n");
            printf("ê° ì¥ë©´ì—ì„œ ì œì‹œë˜ëŠ” ì„ íƒì§€ë¥¼ ìˆ«ìë¡œ ì…ë ¥í•˜ë©´, ì„ íƒì— ë”°ë¼ ìƒíƒœ(ìŠ¤íŠ¸ë ˆìŠ¤/ì‹¤ë ¥/ì—¬ì¹œ)\n");
            printf("ì´ ë³€í™”í•˜ê³  ë‹¤ìŒ ì¥ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.\n");
            printf("\n- ì…ë ¥ ë°©ë²•: ê° ì„ íƒì§€ì˜ ë²ˆí˜¸(1~3)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n");
            printf("- 'ì¢…ë£Œ'ëŠ” ì–¸ì œë“  ë©”ì¸ ë©”ë‰´ì—ì„œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n");
            printf("\nì„¤ëª…ì„ ì½ìœ¼ì…¨ìœ¼ë©´ Enterë¥¼ ëˆ„ë¥´ì„¸ìš”...");
            fgets(buf, sizeof(buf), stdin); // Enter ëŒ€ê¸°
            printf("\n");
            // ì„¤ëª…ì„ ì½ê³  ë‚œ í›„ ë‹¤ì‹œ ë©”ë‰´ë¥¼ ë³´ì—¬ì£¼ê¸° ìœ„í•´ while ë£¨í”„ ì¬ì‹¤í–‰
            continue;
        }
        else if (val == 3) {
            return 3; // ì¢…ë£Œ
        }
        else {
            continue;
        }
    }
}

void printSpecialEnding(const State* st) {
    printf("\n======= íŠ¹ìˆ˜ ì—”ë”© =======\n");

    if (st->proFlag >= 1) {
        printf("[ì „ë¬¸í•˜ì‚¬ ì—”ë”©] \"ìë„¤, ì¼ ë¨¸ë¦¬ê°€ ì•„ì£¼ ì¢‹ì•„. ë‚˜ë‘ 6ê°œì›”ë§Œ ë” í•˜ì§€?\"í–‰ë³´ê´€ë‹˜ì˜ ë‹¬ì½¤í•œ ì œì•ˆ, ê·¸ë¦¬ê³  ë‚´ ì†ì— ë“¤ë¦° ì„ê´€ ì§€ì›ì„œ. ì •ì‹ ì„ ì°¨ë ¸ì„ ë• ì´ë¯¸ ë„ì¥ì€ ì°í˜€ ìˆì—ˆë‹¤.\n");
        return;
    }

    if (st->badFlag >= 3) {
        printf("[ë§ˆìŒì˜ í¸ì§€ ì—”ë”©] ì¤‘ëŒ€ì¥ë‹˜ ì±…ìƒ ìœ„ì— ìˆ˜ë¶ì´ ìŒ“ì¸ í° ë´‰íˆ¬ë“¤. \"ë” ì´ìƒì€ ëª» ì°¸ê² ìŠµë‹ˆë‹¤...\" \"ì•…ë§ˆë¥¼ ë³´ì•˜ìŠµë‹ˆë‹¤...\" ìµìˆ™í•œ ë‚´ ì´ë¦„ì´ ë³´ì¸ë‹¤. í—Œë³‘ëŒ€ ì°¨ê°€ ìœ„ë³‘ì†Œë¥¼ í†µê³¼í–ˆë‹¤.");
        return;
    }

    if (st->nojobFlag >= 1) { //2í•™ë…„ 0,11 ìŠ¤í† ë¦¬ ë¶„ê¸°ì 
        printf("[ë°±ìˆ˜ ì—”ë”©] \"í•™êµ ê³µë¶€ëŠ” ë‚˜ë‘ ì•ˆ ë§ì•„.\" íŒ¨ê¸°ë¡­ê²Œ ìì²´ íœ´ê°•ì„ ë•Œë ¸ë‹¤. ë„ì„œê´€ì— ê°„ë‹¤ëŠ” í•‘ê³„ë¡œ PCë°©ì„ ê°”ê³ , ì½”ë”© ê³µë¶€ ëŒ€ì‹  ë„·í”Œë¦­ìŠ¤ë¥¼ ì •ì£¼í–‰í–ˆë‹¤. ë™ê¸°ë“¤ì´ ì¡¸ì—… ê°€ìš´ì„ ì…ì„ ë•Œ, ë‚˜ëŠ” ì¬ìˆ˜ê°• ì‹ ì²­ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ìˆë‹¤.");
        return;
    }

    if (st->blackmoneyFlag >= 1) { //2í•™ë…„ 8,12,13 ìŠ¤í† ë¦¬ ë¶„ê¸°ì 
        printf("[íš¡ë ¹ ì—”ë”©] \"ì, ì´ê±° ë¹„ë°€ì´ë‹¤? ë§›ìˆëŠ” ê±°ë‚˜ ì‚¬ ë¨¹ì–´.\" ì„ ë°°ê°€ ê±´ë„¨ ë‘íˆ¼í•œ ë´‰íˆ¬. ë‚˜ëŠ” ê·¸ë‚  ì¥ë¶€ë¥¼ ë®ì—ˆê³  ì–‘ì‹¬ë„ í•¨ê»˜ íŒ”ì•˜ë‹¤. ì–¼ë§ˆ í›„ í•™êµì— ê²½ì°°ì°¨ê°€ ë“¤ì´ë‹¥ì³¤ë‹¤. ì°¸ê³ ì¸ ì¡°ì‚¬? ì•„ë‹ˆ, ë‚˜ë„ ê³µë²”ì´ì—ˆë‹¤.");
        return;
    }

    if (st->gametrollFlag >= 1) { //2í•™ë…„ 14,15 ìŠ¤í† ë¦¬ ë¶„ê¸°ì 
        printf("[íŠ¸ë¡¤ ì—”ë”©] \"ì•„ë‹ˆ ê²Œì„ì¸ë° ì™œ ì´ë ‡ê²Œ ì§„ì§€í•¨? ã…‹ã…‹\" ë‚˜ëŠ” ê°•ì² ì‹¬ì¥ ìœ ë¯¸ë¡œ í˜‘ê³¡ì„ ëˆ„ë³ë‹¤. ë‚˜ë§Œ ì¬ë°Œì—ˆë‹¤. ê²Œì„ì´ ëë‚˜ìë§ˆì ì¹œêµ¬ë“¤ì€ ì¡°ìš©íˆ ì§ì„ ì‹¸ì„œ ë‚˜ê°”ë‹¤.");
        return;
    }

    if (st->blameFlag >= 5) { //2í•™ë…„ 14,16 ìŠ¤í† ë¦¬ ë¶„ê¸°ì 
        printf("[ì†ì ˆ ì—”ë”©] \"ì•¼! ì´ê±¸ ëª»í•˜ëƒ? ë„¤ê°€ ì‚¬ëŒì´ëƒ?\" ë‚´ ê³ í•¨ì†Œë¦¬ì— PCë°©ì´ ì¡°ìš©í•´ì¡Œë‹¤. ì¹œêµ¬ì˜ ëˆˆë¹›ì´ ì°¨ê°‘ê²Œ ì‹ì—ˆë‹¤. \"ê·¸ë˜... ë„ˆ ì˜ë‚¬ë‹¤. ë„ˆ í˜¼ì í•´ë¼.\" ë‹¨í†¡ë°©ì˜ ìˆ«ìê°€ í•˜ë‚˜ì”© ì¤„ì–´ë“ ë‹¤. ì´ì œ ì•„ë¬´ë„ ë‚˜ë¥¼ ë¶€ë¥´ì§€ ì•ŠëŠ”ë‹¤.");
        return;
    }

    if (st->badgamerFlag >= 1) { //2í•™ë…„ 14,17 ìŠ¤í† ë¦¬ ë¶„ê¸°ì 
        printf("[ê²Œì„ì¤‘ë… ì—”ë”©] \"ë‚´ í”¼ì§€ì»¬ ë´¤ëƒ? ì´ê±´ í”„ë¡œ ê°ì´ë‹¤.\" ì°©ê°ì´ì—ˆë‹¤. ë‚´ê°€ ìˆëŠ” ê³³ì€ ë¡¤ë“œì»µ ê²°ìŠ¹ ë¬´ëŒ€ê°€ ì•„ë‹ˆë¼ ì»´ì»´í•œ PCë°© êµ¬ì„ì´ì—ˆë‹¤. ìŒ“ì—¬ê°€ëŠ” ì»µë¼ë©´ ìš©ê¸°ì™€ ë©ˆì¶°ë²„ë¦° í‹°ì–´. í˜„ì‹¤ ë¡œê·¸ì•„ì›ƒì€ ë¶ˆê°€ëŠ¥í–ˆë‹¤.");
        return;
    }
}

int ask_fixed_question(int idx, State* st, const Event* event) {
    // 1. ì§ˆë¬¸ì§€ ê°€ì ¸ì˜¤ê¸°
    // events_y1_fixed ë°°ì—´ì—ì„œ idxë²ˆì§¸ ì§ˆë¬¸ì„ ê°€ì ¸ì˜´
    const Event* ev = &event[idx];

    // 2. í™”ë©´ì— ì¶œë ¥ (runEvent ì•ˆ ì“°ê³  ì§ì ‘ í•¨)
    printf("\n[ë©”ì¸ ìŠ¤í† ë¦¬ %dë²ˆ]\n", idx);
    printf("Q. %s\n", ev->question);
    printf(" 1) %s\n", ev->choice1);
    printf(" 2) %s\n", ev->choice2);
    printf(" 3) %s\n", ev->choice3);

    // 3. ì…ë ¥ ë°›ê¸°
    int sel;
    printf("ì„ íƒ>> ");
    scanf("%d", &sel);

    // 4. ìƒíƒœ(ëŠ¥ë ¥ì¹˜) ì—…ë°ì´íŠ¸ ì§ì ‘ ê³„ì‚°
    const int* change = NULL; // ë³€í™”ëŸ‰ì„ ê°€ë¦¬í‚¬ í¬ì¸í„°
    int next_idx = -1;        // ë‹¤ìŒ ê°ˆ ê³³

    if (sel == 1) {
        change = ev->stateChange1;
        next_idx = ev->next1;
    }
    else if (sel == 2) {
        change = ev->stateChange2;
        next_idx = ev->next2;
    }
    else {
        change = ev->stateChange3;
        next_idx = ev->next3;
    }

    // ì‹¤ì œ ë°˜ì˜
    st->stress += change[0];
    st->skill += change[1];
    if (change[2] == 1) st->gf = 1; // ì—¬ì¹œ ìƒê¹€

    printf(">> (ê²°ê³¼) ìŠ¤íŠ¸ë ˆìŠ¤ %+d, ì‹¤ë ¥ %+d\n", change[0], change[1]);

    // 5. ë‹¤ìŒ ì§ˆë¬¸ ë²ˆí˜¸ ë°˜í™˜
    return next_idx;
}

// ========================================================
// [í•¨ìˆ˜ 2] ë¬´ì‘ìœ„ ì§ˆë¬¸ì§€ í•˜ë‚˜ë¥¼ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
// - ë¬´ì‘ìœ„ ë°°ì—´ ì „ì²´ í¬ê¸°(pool_size)ë¥¼ ë°›ì•„ì„œ ì•Œì•„ì„œ ëœë¤ìœ¼ë¡œ ë½‘ìŒ
// ========================================================
void ask_random_question(int pool_size, State* st, const Event* event) {
    // 1. ëœë¤ìœ¼ë¡œ í•˜ë‚˜ ë½‘ê¸°
    int r = rand() % pool_size;
    const Event* ev = &event[pool_size];

    printf("\n>>> ğŸ² ëŒë°œ ìƒí™© ë°œìƒ! <<<\n");
    printf("Q. %s\n", ev->question);
    printf(" 1) %s\n", ev->choice1);
    printf(" 2) %s\n", ev->choice2);
    printf(" 3) %s\n", ev->choice3);

    int sel;
    printf("ì„ íƒ>> ");
    scanf("%d", &sel);

    const int* change = NULL;
    if (sel == 1) change = ev->stateChange1;
    else if (sel == 2) change = ev->stateChange2;
    else change = ev->stateChange3;

    st->stress += change[0];
    st->skill += change[1];

    printf(">> (ëŒë°œ ê²°ê³¼) ìŠ¤íŠ¸ë ˆìŠ¤ %+d, ì‹¤ë ¥ %+d\n", change[0], change[1]);
    printf(">>> ìƒí™© ì¢…ë£Œ, ë‹¤ì‹œ ì¼ìƒìœ¼ë¡œ...\n");
}